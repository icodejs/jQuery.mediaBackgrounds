(function(a,b,c,d){a.fn.mediaBackgrounds=function(c){var d={timers:{request:{prev_req:0,diff_ms:0,elaps:0,interval_id:-1}},errors:[],cache:{items:[]},favorites:[],win_width:1024,win_height:1024,is_loading:!1,ss_mode:!1,max_container_height:450},e={bg_container:null,body:null,buttons:null,controls_container:null,favorites_container:null,favorite_show_hide:null,img_size:null,keypress_detector:null,ss_checkbox:null,status:null,terms:null,window:null,ws_dropdown:null};(function(){typeof Array.prototype.contains!="function"&&(Array.prototype.contains=function(a,b){var c=this.length;while(c--)if(b){if(this[c][b]===a)return!0}else if(this[c]===a)return!0;return!1})})(),function(){a.xhrPool=[],a.xhrPool.abortAll=function(){a(this).each(function(a,b){b.abort()}),a.xhrPool.length=0},a.ajaxSetup({beforeSend:function(b){a.xhrPool.push(b)},complete:function(b){var c=a.xhrPool.indexOf(b);c>-1&&a.xhrPool.splice(c,1)}}),a.fn.css_attr_val=function(a){return parseInt(this.css(a).slice(0,-2))}}();var f={add_favorite:function(b){if(b&&b.data("img_dims")){var c=b.data("img_dims"),h=255,j=132;d.favorites.contains(c.url,"url")||a("<img />").attr({src:c.url,width:h,height:j}).load(function(){var b=a(this),h=e.favorites_container.find("#favorites"),k=h.find("ul")[0]?h.find("ul"):a("<ul />").appendTo(h),l=a('<a class="remove" href="/"><i class="icon icon_x"></a>').on("click",g.remove_favorite_image),m=a("<li />").append(l).hide(),n=a("<a />").attr({href:c.url,target:"_blank"}).html(b),o=f.set_favorites_container_height(k,j,k.find("li").length===0),p=e.favorite_show_hide.data("state"),q={element:e.favorite_show_hide,state:"open",do_toggle:p==="closed"},r={element:h,state:p,overflow:"auto",height:o>d.max_container_height?d.max_container_height:o,speed:750};m.prepend(n).prependTo(k).slideDown(1e3),g.view_favorites_show(r,function(){g.view_favorites_button(q),e.keypress_detector.focus(),d.favorites.push(c),i.set_status("save",d.favorites.length+" image(s) saved in your favorites!",d.favorites.length)});var s=e.favorites_container.attr("style").replace(" ","");s.indexOf("display:none;")>=0&&e.favorites_container.fadeIn()})}},set_favorites_container_height:function(a,b,c){var d=a.find("li");len=d.length+1;if(d.length){var e=d.css_attr_val("margin-bottom");return d.first().outerHeight(!0)*len+len*e}return c?a.outerHeight(!0)+b+12:0},email:function(){i.set_status("email","Check your inbox! (To do)")},tweet:function(){i.set_status("tweet","tweet tweet (To do)")},save:function(){i.set_status("save","Your favorites list has been saved. (To do)")},help:function(){i.set_status("help","Use the spacebar to load new images. (To do)")},get_rnd_term:function(){var a=0,b=j.search_terms,c="";return b.length===1?f.parse_search_term(b[a]):(a=f.get_rnd_int(0,b.length-1),c=f.parse_search_term(b[a]),i.set_status("get_rnd_term","search term: "+c),c)},parse_search_term:function(a){return a.split(" ").join("+")},get_rnd_int:function(a,b){return Math.floor(Math.random()*(b-a+1))+a},loading:{start_time:0,elaps:0,interval_id:-1,begin:function(){if(f.loading.start_time>0)return!0;f.loading.start_time===0&&(f.loading.start_time=(new Date).getTime()),f.loading.interval_id=setInterval(function(){var a=(new Date).getTime(),b=(a-f.loading.start_time)/1e3;if(b>20)return f.loading.reset(!0)},2e3)},reset:function(b){return b&&(a.xhrPool.length>0&&a.xhrPool.abortAll(),i.update_ui(e.bg_container)),f.loading.start_time=0,clearInterval(f.loading.interval_id)},active:function(){return f.loading.start_time>0}}},g={view_favorites:function(a,b,c){var e=b.data("state"),f=b.find("i"),h=c.find("ul").outerHeight(!0)+10;btn_config={element:b,state:e==="open"?"closed":"open",do_toggle:!0},container_config={element:c,state:btn_config.state,overflow:e==="open"?"hidden":"auto",height:e==="open"?10:h>d.max_container_height?d.max_container_height:h,speed:750},g.view_favorites_show(container_config,function(){g.view_favorites_button(btn_config)})},view_favorites_button:function(a){a.element.data({state:a.state}),a.do_toggle&&a.element.find("i").toggleClass("icon_state_close","icon_state_open")},view_favorites_show:function(b,c){var d=b.state==="open"?"easeOutQuad":"easeInQuad";b.element.stop(!0,!0),b.element.animate({height:b.height},b.speed,d,function(){a(this).css({overflow:b.overflow}),c()})},remove_favorite_image:function(b){b.preventDefault();var c=a(this).closest("li");c.slideUp(1e3,function(){var f,h,i,j=a(this);src=c.find("img").attr("src"),$siblings=j.siblings(),$favorites=e.favorites_container.find("#favorites"),j.remove();for(f=0,h=d.favorites.length;f<h;f+=1)if(d.favorites[f].url.toLowerCase()===src.toLowerCase()){i=d.favorites.splice(f,1);break}$siblings.length?g.view_favorites(b,e.favorite_show_hide.data({state:"closed"}),$favorites):e.favorites_container.slideUp(1e3,function(){var b=a(this).find("#favorites").slideUp(1e3).removeAttr("style").find("ul").remove().end().end().hide()})})}},h=this,i={init:function(){return e.controls_container=a("#controls"),e.status=a(".status"),e.favorites_container=a("#favorites_container"),e.terms=a("#terms"),e.img_size=a("#img_size"),e.buttons=a(".button"),e.ws_dropdown=a("#wallpapers_sites"),e.ss_checkbox=a("#slideshow"),e.favorite_show_hide=a("#favorite_controls a"),e.window=a(b),d.win_width=e.window.width(),d.win_height=e.window.height(),e.window.on("resize",i.resize_window).on("beforeunload",function(a){if(e.favorites_container.find("#favorites li").length>0)return"You will loose your favorite images."}),h.each(function(){a("*").on("contextmenu",function(){return!1}),e.body=a(this).height(d.win_height).on("click",function(a){a.target.id!=="controls"&&a.target.parentElement.id!=="controls"&&e.keypress_detector.focus()}),e.bg_container=a("<div />").addClass("bg_container").height(d.win_height).hide().prependTo(e.body),e.buttons.on("click",function(b){b.preventDefault(),e.keypress_detector.focus();switch(a(this).attr("id").toLowerCase()){case"fav":f.add_favorite(e.bg_container);break;case"save":f.save(e.bg_container);break;case"email":f.email(e.bg_container);break;case"tweet":f.tweet(e.bg_container);break;case"help":f.help(e.bg_container)}}),e.ws_dropdown.on("change",function(){var b=a(this).val();b.toLowerCase()!=="none"&&e.terms.val(b),e.keypress_detector.focus()}),e.ss_checkbox.on("change",function(){var b=e.controls_container.find("input, select, button").not("#slideshow, #fav");d.ss_mode=a(this).attr("checked")?!0:!1,d.ss_mode?(d.timers.request.interval_id=setInterval(function(){a.xhrPool.length===0&&!d.loading&&i.update_ui(e.bg_container)},j.interval),b.attr({disabled:"disabled"}).addClass("disabled"),i.set_status("init","Slideshow mode. A new image will load in approximately "+j.interval/1e3+" seconds.")):(clearInterval(d.timers.request.interval_id),b.removeAttr("disabled").removeClass("disabled"),i.set_status("init","Slideshow cancelled. Press the spacebar to load new images."))}),e.favorite_show_hide.on("click",function(b){b.preventDefault(),g.view_favorites(b,a(this),a("#favorites"))}).data({state:"closed"}),e.keypress_detector=a("<input />").attr({id:"txtInput",type:"text"}).addClass("keypress_detector").focus().on("keypress",function(a){a.preventDefault();if(a.which===32&&!d.ss_mode){var b=(new Date).getTime();if(d.timers.request.prev_req===0)d.timers.request.prev_req=b;else{d.timers.request.diff_ms=b-d.timers.request.prev_req,d.timers.request.elaps=d.timers.request.diff_ms/1e3;if(!(d.timers.request.elaps>=2))return;d.timers.request.prev_req=b}i.update_ui(e.bg_container)}}).appendTo(e.body),i.get_bg(e.bg_container)})},get_bg:function(b){if(d.errors.length>10)return!d.ss_mode&&e.body.find(".loader").fadeOut(1e3,function(){a(this).remove(),d.errors=[]}),i.set_status("get_bg","Insuffient images for the current URL. Please enter another URL or keyword(s)",d.errors);var c=0,g={},h=e.terms.val().toLowerCase(),k=h.indexOf("http://")>=0||h.indexOf("www")>=0;a(".loader").length===0&&!d.ss_mode&&a("<div />").hide().addClass("loader").append(a("<img />").attr("src",j.loading_image)).appendTo(e.body).fadeIn(),f.loading.begin(),i.check_cache(h,function(a){var e=d.cache.items;if(k&&a>=0&&e[a]&&e[a].images.length>0){var j=e[a].images;c=f.get_rnd_int(0,j.length-1),g={url:j[c].url},i.set_bg(g,b)}else d.errors=[],i.get_json(k,h,function(a,e){if(a)return d.errors.push(a),i.set_status("get_bg",a);e&&e.length>0&&(c=f.get_rnd_int(0,e.length-1),g={url:e[c].url},i.set_bg(g,b))})})},set_bg:function(b,c){b&&b.url&&(i.preload_img(b.url,0,function(f,g){var h=a(".bg_container");if(f)return d.errors.push(f),i.get_bg(c);e.bg_container=a("<div />").addClass("bg_container").height(d.win_height).css({"background-image":'url("'+b.url+'")',"background-position":"top","background-repeat":"repeat",height:d.win_height}).data("img_dims",g).prependTo(e.body),h.fadeOut(1e3,function(){a(this).remove()})}),e.keypress_detector.focus())},get_json:function(b,c,e){j.api_url.length>0&&b?url=j.api_url+c:(url="http://ajax.googleapis.com/ajax/services/search/images?v=1.0&q=",url+=c.length>0?f.parse_search_term(c):f.get_rnd_term(),url+="&imgsz=xlarge|xxlarge|huge",url+="&imgtype=photo",url+="&rsz=8",url+="&start="+f.get_rnd_int(1,50)),a.xhrPool.length>0&&a.xhrPool.abortAll(),a.ajax({url:url,dataType:"jsonp",error:function(a,b,c){return e({func_name:"get_json",desc:b,data:c})}}).done(function(a,f){if(f==="success")try{if(a.error)return e({func_name:"get_json",desc:a.error,data:a});if(j.api_url.length>0&&b)return!d.cache.items.contains(c,"id")&&d.cache.items.push({id:c,images:a}),e(null,a);var g=a.responseData.results;return g.length?e(null,g):e({desc:"no results"})}catch(h){return e({func_name:"get_json",desc:h.toString(),data:h})}})},preload_img:function(b,c,g){d.is_loading=!0,e.body.find("img.preloaded").remove(),a(new Image).hide().load(function(){var h=this,j=h.width,k=h.height;i.set_status("preload_img","Loaded image with dimensions: "+j+" x "+k);var l=d.win_width,m=d.win_height;e.img_size.val().indexOf("x")>=0?(l=e.img_size.val().split("x")[0],m=e.img_size.val().split("x")[1]):(j*=1.5,k*=1.5);if(j<l||k<m)return g({func_name:"preload_img",desc:"image returned is too small"});setTimeout(function(){var c={width:h.width,height:h.height,url:b};d.ss_mode?(d.is_loading=!1,g(null,c)):e.body.find(".loader").fadeOut(1e3,function(){a(this).remove(),d.is_loading=!1,g(null,c)}),f.loading.reset()},c)}).addClass("preloaded").attr("src",b).prependTo("body").error(function(a){return i.set_status("preload_img","404 (Not Found)"),g({func_name:"preload_img",desc:"404 (Not Found)",data:a})})},resize_window:function(){var b=a(this);d.win_width=b.width(),d.win_height=b.height(),e.bg_container.css({height:d.win_height}),e.body.css({height:d.win_height})},update_ui:function(a){a&&i.get_bg(a)},check_cache:function(a,b){var c,e=d.cache.items,f=e.length;if(e.length>0)for(c=0;c<f;c+=1)if(a.toLowerCase()===e[c].id.toLowerCase())return b(c);return b(-1)},set_status:function(b,c,d){e.status.find("div").fadeOut().end().html("").append(a("<div>"+c+(b==="save"?' <a href="#" id="view" class="button">view</a>':"")+" ..."+"</div>").fadeIn(1e3)).fadeIn()},destroy:function(){return h.each(function(){})}},j=a.extend({api:"google_image_search",api_url:"",loading_image:"img/loader.gif",search_terms:["graffiti"],media_type:"img",interval:15e3,user_id:-1,rest_url:""},c);i.init()}})(jQuery,window,document)