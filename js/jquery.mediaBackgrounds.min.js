(function(a,b,c,d){a.fn.mediaBackgrounds=function(c){var e={timer:{prev_req:0,diff_ms:0,elaps:0},errors:[],cache:{items:[]},favorites:[],win_width:1024,win_height:1024,interval_id:d,loading:!1,ss_mode:!1,max_container_height:450},f={bg_container:null,body:null,buttons:null,controls_container:null,favorites_container:null,favorite_show_hide:null,img_size:null,keypress_detector:null,ss_checkbox:null,status:null,terms:null,window:null,ws_dropdown:null};(function(){typeof Array.prototype.contains!="function"&&(Array.prototype.contains=function(a,b){var c=this.length;while(c--)if(b){if(this[c][b]===a)return!0}else if(this[c]===a)return!0;return!1})})(),function(){a.xhrPool=[],a.xhrPool.abortAll=function(){a(this).each(function(a,b){b.abort()}),a.xhrPool.length=0},a.ajaxSetup({beforeSend:function(b){a.xhrPool.push(b)},complete:function(b){var c=a.xhrPool.indexOf(b);c>-1&&a.xhrPool.splice(c,1)}}),a.fn.css_attr_val=function(a){return parseInt(this.css(a).slice(0,-2))}}();var g={add_favorite:function(b){if(b&&b.data("img_dims")){var c=b.data("img_dims"),d=255,i=132;e.favorites.contains(c.url,"url")||a("<img />").attr({src:c.url,width:d,height:i}).load(function(){var b=a(this),d=f.favorites_container.find("#favorites"),k=d.find("ul")[0]?d.find("ul"):a("<ul />").appendTo(d),l=a('<a class="remove" href="/"><i class="icon icon_x"></a>').on("click",h.remove_favorite_image),m=a("<li />").append(l).hide(),n=a("<a />").attr({href:c.url,target:"_blank"}).html(b),o=g.set_favorites_container_height(k,i,k.find("li").length===0),p=f.favorite_show_hide.data("state"),q={element:f.favorite_show_hide,state:"open",do_toggle:p==="closed"},r={element:d,state:p,overflow:"auto",height:o>e.max_container_height?e.max_container_height:o,speed:750};m.prepend(n).prependTo(k).slideDown(1e3),h.view_favorites_show(r,function(){h.view_favorites_button(q),f.keypress_detector.focus(),e.favorites.push(c),j.set_status("save",e.favorites.length+" image(s) saved in your favorites!",e.favorites.length)});var s=f.favorites_container.attr("style").replace(" ","");s.indexOf("display:none;")>=0&&f.favorites_container.fadeIn()})}},set_favorites_container_height:function(a,b,c){var d=a.find("li");len=d.length+1;if(d.length){var e=d.css_attr_val("margin-bottom");return d.first().outerHeight(!0)*len+len*e}return c?a.outerHeight(!0)+b+12:0},email:function(){j.set_status("email","Check your inbox! (To do)")},tweet:function(){j.set_status("tweet","tweet tweet (To do)")},save:function(){j.set_status("save","Your favorites list has been saved. (To do)")},help:function(){j.set_status("help","Use the spacebar to load new images. (To do)")},get_rnd_term:function(){var a=0,b=k.search_terms,c="";return b.length===1?g.parse_search_term(b[a]):(a=g.get_rnd_int(0,b.length-1),c=g.parse_search_term(b[a]),j.set_status("get_rnd_term","search term: "+c),c)},parse_search_term:function(a){return a.split(" ").join("+")},get_rnd_int:function(a,b){return Math.floor(Math.random()*(b-a+1))+a}},h={view_favorites:function(a,b,c){var d=b.data("state"),f=b.find("i"),g=c.find("ul").outerHeight(!0)+10;btn_config={element:b,state:d==="open"?"closed":"open",do_toggle:!0},container_config={element:c,state:btn_config.state,overflow:d==="open"?"hidden":"auto",height:d==="open"?10:g>e.max_container_height?e.max_container_height:g,speed:750},h.view_favorites_show(container_config,function(){h.view_favorites_button(btn_config)})},view_favorites_button:function(a){a.element.data({state:a.state}),a.do_toggle&&a.element.find("i").toggleClass("icon_state_close","icon_state_open")},view_favorites_show:function(b,c){var d=b.state==="open"?"easeOutQuad":"easeInQuad";b.element.stop(!0,!0),b.element.animate({height:b.height},b.speed,d,function(){a(this).css({overflow:b.overflow}),c()})},remove_favorite_image:function(b){b.preventDefault();var c=a(this).closest("li");c.slideUp(1e3,function(){var d,g,i,j=a(this);src=c.find("img").attr("src"),$siblings=j.siblings(),$favorites=f.favorites_container.find("#favorites"),j.remove();for(d=0,g=e.favorites.length;d<g;d+=1)if(e.favorites[d].url.toLowerCase()===src.toLowerCase()){i=e.favorites.splice(d,1);break}$siblings.length?h.view_favorites(b,f.favorite_show_hide.data({state:"closed"}),$favorites):f.favorites_container.slideUp(1e3,function(){var b=a(this).find("#favorites").slideUp(1e3).removeAttr("style").find("ul").remove().end().end().hide()})})}},i=this,j={init:function(){return f.controls_container=a("#controls"),f.status=a(".status"),f.favorites_container=a("#favorites_container"),f.terms=a("#terms"),f.img_size=a("#img_size"),f.buttons=a(".button"),f.ws_dropdown=a("#wallpapers_sites"),f.ss_checkbox=a("#slideshow"),f.favorite_show_hide=a("#favorite_controls a"),f.window=a(b),e.win_width=f.window.width(),e.win_height=f.window.height(),f.window.on("resize",j.resize_window).bind("beforeunload",function(a){if(f.favorites_container.find("#favorites li").length>0)return"You will loose your favorite images."}),i.each(function(){a("*").bind("contextmenu",function(){return!1}),f.body=a(this).height(e.win_height).on("click",function(a){a.target.id!=="controls"&&a.target.parentElement.id!=="controls"&&f.keypress_detector.focus()}),f.bg_container=a("<div />").addClass("bg_container").height(e.win_height).hide().prependTo(f.body),f.buttons.on("click",function(b){b.preventDefault(),f.keypress_detector.focus();switch(a(this).attr("id").toLowerCase()){case"fav":g.add_favorite(f.bg_container);break;case"save":g.save(f.bg_container);break;case"email":g.email(f.bg_container);break;case"tweet":g.tweet(f.bg_container);break;case"help":g.help(f.bg_container)}}),f.ws_dropdown.on("change",function(){var b=a(this).val();b.toLowerCase()!=="none"&&f.terms.val(b),f.keypress_detector.focus()}),f.ss_checkbox.on("change",function(){var b=f.controls_container.find("input, select, button").not("#slideshow, #fav");e.ss_mode=a(this).attr("checked")?!0:!1,e.ss_mode?(e.interval_id=setInterval(function(){a.xhrPool.length===0&&!e.loading&&j.update_ui(f.bg_container)},k.interval),b.attr({disabled:"disabled"}).addClass("disabled"),j.set_status("init","Slideshow mode. A new image will load in approximately "+k.interval/1e3+" seconds.")):(clearInterval(e.interval_id),b.removeAttr("disabled").removeClass("disabled"),j.set_status("init","Slideshow cancelled. Press the spacebar to load new images."))}),f.favorite_show_hide.on("click",function(b){b.preventDefault(),h.view_favorites(b,a(this),a("#favorites"))}).data({state:"closed"}),f.keypress_detector=a("<input />").attr({id:"txtInput",type:"text"}).addClass("keypress_detector").focus().on("keypress",function(a){a.preventDefault();if(a.which===32&&!e.ss_mode){var b=(new Date).getTime();if(e.timer.prev_req===0)e.timer.prev_req=b;else{e.timer.diff_ms=b-e.timer.prev_req,e.timer.elaps=e.timer.diff_ms/1e3;if(!(e.timer.elaps>=2))return;e.timer.prev_req=b}j.update_ui(f.bg_container)}}).appendTo(f.body),j.get_bg(f.bg_container)})},get_bg:function(b){if(e.errors.length>10)return!e.ss_mode&&f.body.find(".loader").fadeOut(1e3,function(){a(this).remove(),e.errors=[]}),j.set_status("get_bg","Insuffient images for the current URL. Please enter another URL or keyword(s)",e.errors);var c=0,d={},h=f.terms.val().toLowerCase(),i=h.indexOf("http://")>=0||h.indexOf("www")>=0;a(".loader").length===0&&!e.ss_mode&&a("<div />").hide().addClass("loader").append(a("<img />").attr("src",k.loading_image)).appendTo(f.body).fadeIn(),j.check_cache(h,function(a){var f=e.cache.items;if(i&&a>=0&&f[a]&&f[a].images.length>0){var k=f[a].images;c=g.get_rnd_int(0,k.length-1),d={url:k[c].url},j.set_bg(d,b)}else e.errors=[],j.get_json(i,h,function(a,e){if(a)return j.set_status("get_bg",a);e&&e.length>0&&(c=g.get_rnd_int(0,e.length-1),d={url:e[c].url},j.set_bg(d,b))})})},set_bg:function(b,c){b&&b.url&&(j.preload_img(b.url,0,function(d,g){var h=a(".bg_container");if(d)return j.get_bg(c);f.bg_container=a("<div />").addClass("bg_container").height(e.win_height).css({"background-image":'url("'+b.url+'")',"background-position":"top","background-repeat":"repeat",height:e.win_height}).data("img_dims",g).prependTo(f.body),h.fadeOut(1e3,function(){a(this).remove()})}),f.keypress_detector.focus())},get_json:function(b,c,d){k.api_url.length>0&&b?url=k.api_url+c:(url="http://ajax.googleapis.com/ajax/services/search/images?v=1.0&q=",url+=c.length>0?g.parse_search_term(c):g.get_rnd_term(),url+="&imgsz=xlarge|xxlarge|huge",url+="&imgtype=photo",url+="&rsz=8",url+="&start="+g.get_rnd_int(1,50)),a.xhrPool.length>0&&a.xhrPool.abortAll(),a.ajax({url:url,dataType:"jsonp",error:function(a,b,c){return e.errors.push({func_name:"get_json",desc:b,data:c})}}).done(function(a,f){if(f==="success")try{if(a.error)return e.errors.push({func_name:"get_json",desc:a.error,data:a}),d(a.error);if(k.api_url.length>0&&b)return!e.cache.items.contains(c,"id")&&e.cache.items.push({id:c,images:a}),d(null,a);var g=a.responseData.results;return g.length?d(null,g):d("no results")}catch(h){var i={func_name:"get_json",desc:h.toString(),data:h};return e.errors.push(i),d(i)}})},preload_img:function(b,c,d){var g;e.loading=!0,f.body.find("img.preloaded").remove(),a(new Image).hide().load(function(){var g=this,h=g.width,i=g.height;j.set_status("preload_img","Loaded image with dimensions: "+h+" x "+i);var k=e.win_width,l=e.win_height;f.img_size.val().indexOf("x")>=0?(k=f.img_size.val().split("x")[0],l=f.img_size.val().split("x")[1]):(h*=1.5,i*=1.5);if(h<k||i<l)return error={func_name:"preload_img",desc:"image returned is too small"},e.errors.push(error),d(error);setTimeout(function(){var c={width:g.width,height:g.height,url:b};e.ss_mode?(e.loading=!1,d(null,c)):f.body.find(".loader").fadeOut(1e3,function(){a(this).remove(),e.loading=!1,d(null,c)})},c)}).addClass("preloaded").attr("src",b).prependTo("body").error(function(a){return error={func_name:"preload_img",desc:"404 (Not Found)",data:a},e.errors.push(error),j.set_status("preload_img",error.desc),d(error)})},resize_window:function(){var b=a(this);e.win_width=b.width(),e.win_height=b.height(),f.bg_container.css({height:e.win_height}),f.body.css({height:e.win_height})},update_ui:function(a){a&&j.get_bg(a)},check_cache:function(a,b){var c,d=e.cache.items,f=d.length;if(d.length>0)for(c=0;c<f;c+=1)if(a.toLowerCase()===d[c].id.toLowerCase())return b(c);return b(-1)},set_status:function(b,c,d){f.status.find("div").fadeOut().end().html("").append(a("<div>"+c+(b==="save"?' <a href="#" id="view" class="button">view</a>':"")+" ..."+"</div>").fadeIn(1e3)).fadeIn()},destroy:function(){return i.each(function(){})}},k=a.extend({api:"google_image_search",api_url:"",loading_image:"img/loader.gif",search_terms:["graffiti"],media_type:"img",interval:15e3,user_id:-1,rest_url:""},c);j.init()}})(jQuery,window,document)